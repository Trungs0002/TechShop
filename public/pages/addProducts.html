<!DOCTYPE html> 
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách sản phẩm</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --danger-color: #f44336;
            --light-bg: #f9f9f9;
            --border-color: #ddd;
            --text-color: #333;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 40px;
            color: var(--text-color);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: var(--shadow);
        }

        th,
        td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .btn {
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: 0.3s ease;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .button-group {
            text-align: center;
            margin-bottom: 30px;
        }

        #add-product-form {
            display: none;
            background-color: var(--light-bg);
            padding: 20px;
            max-width: 600px;
            margin: 0 auto 30px auto;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        #add-product-form table {
            width: 100%;
        }

        #add-product-form td {
            padding: 10px 5px;
        }

        #add-product-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .category-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Danh sách sản phẩm</h1>

    <div class="button-group">
        <button class="btn btn-primary" id="add-product-btn">Thêm sản phẩm</button>
        <button class="btn btn-primary" id="add-many-product-btn">Import CSV/JSON</button>
        <input type="file" id="file-upload" accept=".json,.csv" style="display:none">
    </div>

    <div id="add-product-form">
        <div class="form-title">Thêm sản phẩm mới</div>
        <div class="category-options" id="category-options"></div>
        <table>
            <tr>
                <td><label for="category-select">Loại hàng:</label></td>
                <td>
                    <select id="category-select">
                        <option value="" disabled selected>-- Chọn loại hàng --</option>
                        <option value="CPU">CPU</option>
                        <option value="RAM">RAM</option>
                        <option value="Ổ cứng">Ổ cứng</option>
                        <option value="GPU">GPU</option>
                        <option value="Mainboard">Mainboard</option>
                        <option value="PSU">PSU</option>
                        <option value="Case">Case</option>
                        <option value="Tản nhiệt">Tản nhiệt</option>
                        <option value="bàn phím">bàn phím</option>
                        <option value="chuột">chuột</option>
                        <option value="màn hình">màn hình</option>
                        <option value="card âm thanh">card âm thanh</option>
                        <option value="Thiết bị mạng">Thiết bị mạng</option>
                        <option value="Khác">Khác</option>
                    </select>
                </td>
            </tr>
            <tr class="hidden" id="custom-category-row">
                <td><label for="custom-category">Loại hàng:</label></td>
                <td><input type="text" id="custom-category"></td>
            </tr>
            <tr class="hidden" id="custom-prefix-row">
                <td><label for="custom-prefix">Mã hàng:</label></td>
                <td><input type="text" id="custom-prefix"></td>
            </tr>
            <tr>
                <td><label for="image">Hình ảnh:</label></td>
                <td><input type="file" id="image-upload" accept="image/* ">
                    <input type="hidden" id="image">
                </td>

            </tr>
            
            <tr>
                <td><label for="id">ID:</label></td>
                <td><input type="text" id="id" disabled></td>
            </tr>
            <tr>
                <td><label for="name">Tên:</label></td>
                <td><input type="text" id="name" placeholder="Tên sản phẩm" required></td>
            </tr>
            <tr>
                <td><label for="price">Giá:</label></td>
                <td><input type="number" id="price" placeholder="Giá" required></td>
            </tr>
            <tr>
                <td><label for="brand">Thương hiệu:</label></td>
                <td><input type="text" id="brand" placeholder="Thương hiệu" list="brand-list" required></td>
            </tr>
            <tr>
                <td><label for="warranty">Bảo hành:</label></td>
                <td><input type="text" id="warranty" placeholder="Bảo hành" list="warranty-list" required></td>
            </tr>
            <tr>
                <td><label>Mô tả:</label></td>
                <td id="discription-container">
                    <div class="discription-pair">
                        <input type="text" placeholder="Nhập Key" class="discription-key">
                        <span>:</span>
                        <input type="text" placeholder="Nhập Value" class="discription-value">
                    </div>
                </td>
            </tr>
        </table>
        <div style="text-align:center; margin-top: 15px;">
            <button class="btn btn-primary" id="save-btn">Lưu</button>
            <button class="btn btn-danger" id="cancel-btn">Hủy</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Hình ảnh</th>
                <th>ID</th>
                <th>Tên sản phẩm</th>
                <th>Giá</th>
                <th>Thương hiệu</th>
                <th>Bảo hành</th>
            </tr>
        </thead>
        <tbody id="product-list"></tbody>
    </table>

    <datalist id="brand-list">
        <option value="ASUS">
        <option value="MSI">
        <option value="GIGABYTE">
        <option value="Corsair">
        <option value="Logitech">
    </datalist>
    <datalist id="warranty-list">
        <option value="12 tháng">
        <option value="24 tháng">
        <option value="36 tháng">
    </datalist>

    <script>
     function setupDiscriptionPairInput() {
    const container = document.getElementById('discription-container');
    container.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.target.classList.contains('discription-key') || e.target.classList.contains('discription-value'))) {
            e.preventDefault();
            const div = document.createElement('div');
            div.className = 'discription-pair';
            div.innerHTML = `
                <input type="text" placeholder="Nhập Key" class="discription-key">
                <span>:</span>
                <input type="text" placeholder="Nhập Value" class="discription-value">
            `;
            container.appendChild(div);
            div.querySelector('.discription-key').focus();
        }
    });
}
setupDiscriptionPairInput();

const categorySelect = document.getElementById('category-select');
categorySelect.addEventListener('change', (e) => {
    const selected = e.target.value;
    const idField = document.getElementById('id');

    if (selected === 'Khác') {
        document.getElementById('custom-category-row').classList.remove('hidden');
        document.getElementById('custom-prefix-row').classList.remove('hidden');
        idField.value = '';
    } else {
        document.getElementById('custom-category-row').classList.add('hidden');
        document.getElementById('custom-prefix-row').classList.add('hidden');
        const prefix = selected.normalize("NFD").replace(/[^a-zA-Z]/g, '').substring(0, 3).toUpperCase() + 'X';
        idField.value = generateNextId(prefix);
    }
});

let allProducts = [];

fetch('/api/sanpham')
    .then(res => res.json())
    .then(data => {
        allProducts = data;
        const productList = document.getElementById('product-list');
        data.forEach(sp => {
            const row = document.createElement('tr');
            const imageUrl = sp.image?.trim() || 'images/i9 -14900k.png';
            row.innerHTML = `
                <td><img src="${imageUrl}" style="width: 80px; height: auto;"></td>
                <td>${sp.id}</td>
                <td>${sp.name}</td>
                <td>${parseFloat(sp.price).toLocaleString()} VND</td>
                <td>${sp.brand}</td>
                <td>${sp.warranty}</td>
            `;
            productList.appendChild(row);
        });
    });

function generateNextId(prefix) {
    const matching = allProducts.filter(p => p.id.startsWith(prefix));
    let maxNum = 0;
    matching.forEach(p => {
        const num = parseInt(p.id.slice(prefix.length));
        if (!isNaN(num)) maxNum = Math.max(maxNum, num);
    });
    return prefix + (maxNum + 1).toString().padStart(4, '0');
}

document.getElementById('add-product-btn').addEventListener('click', () => {
    document.getElementById('add-product-form').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
});

document.getElementById('image-upload').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        document.getElementById('image').value = e.target.result;
    };
    reader.readAsDataURL(file);
});

document.getElementById('cancel-btn').addEventListener('click', () => {
    document.getElementById('add-product-form').style.display = 'none';
});

document.getElementById('save-btn').addEventListener('click', () => {
    const id = document.getElementById('id').value.trim();
    const name = document.getElementById('name').value.trim();
    const price = document.getElementById('price').value.trim();
    const brand = document.getElementById('brand').value.trim();
    let warranty = document.getElementById('warranty').value.trim();
    const image = document.getElementById('image').value.trim();

    const descriptionElements = document.querySelectorAll('#discription-container .discription-pair');
        const newProduct = { id, name, price: parseFloat(price), brand, warranty, image };

        descriptionElements.forEach(pair => {
            const key = pair.querySelector('.discription-key').value.trim();
            const value = pair.querySelector('.discription-value').value.trim();
            if (key) {
                newProduct[key] = value;
            }
        });

    if (/^\d+$/.test(warranty)) {
        warranty = `${warranty} năm`;
    }

  
    fetch('/api/sanpham', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newProduct)
    })
    .then(res => res.json())
    .then(addedProduct => {
        const row = document.createElement('tr');
        const imageUrl = addedProduct.image?.trim() || 'images/i9 -14900k.png';
        row.innerHTML = `
            <td><img src="${imageUrl}" style="width: 80px; height: auto;"></td>
            <td>${addedProduct.id}</td>
            <td>${addedProduct.name}</td>
            <td>${parseFloat(addedProduct.price).toLocaleString()} VND</td>
            <td>${addedProduct.brand}</td>
            <td>${addedProduct.warranty}</td>
        `;
        document.getElementById('product-list').appendChild(row);
        document.getElementById('add-product-form').style.display = 'none';
        document.getElementById('name').value = '';
        document.getElementById('price').value = '';
        document.getElementById('brand').value = '';
        document.getElementById('warranty').value = '';
        document.getElementById('image').value = '';
        document.getElementById('id').value = '';
        document.getElementById('discription-container').innerHTML = `
            <div class="discription-pair">
                <input type="text" placeholder="Nhập Key" class="discription-key">
                <span>:</span>
                <input type="text" placeholder="Nhập Value" class="discription-value">
            </div>`;
            alert('Thêm sản phẩm thành công!');
    })
    .catch(() => alert('Không thể thêm sản phẩm. Vui lòng thử lại!'));
});

document.getElementById('add-many-product-btn').addEventListener('click', () => {
    document.getElementById('file-upload').click();
});

document.getElementById('file-upload').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            let products = [];

            if (file.name.endsWith('.json')) {
                products = JSON.parse(content);
            } else if (file.name.endsWith('.csv')) {
                const lines = content.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',');
                products = lines.slice(1).map(line => {
                    const values = line.split(',');
                    return headers.reduce((obj, h, i) => {
                        obj[h.trim()] = values[i]?.trim();
                        return obj;
                    }, {});
                });
            }

            if (!Array.isArray(products)) throw new Error('Dữ liệu không hợp lệ');
            if (!confirm(`Đã tải ${products.length} sản phẩm. Bạn có muốn thêm không?`)) return;

            products.forEach(p => {
                const prefix = p.id?.match(/^[A-Z]+X/)?.[0] || p.category?.normalize("NFD").replace(/[^a-zA-Z]/g, '').substring(0, 3).toUpperCase() + 'X';
                const id = p.id || generateNextId(prefix);
                const product = {
                    id,
                    name: p.name,
                    price: parseFloat(p.price),
                    brand: p.brand,
                    warranty: p.warranty,
                    image: p.image || ''
                };

                fetch('/api/sanpham', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(product)
                })
                .then(res => res.json())
                .then(added => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${added.image || 'images/i9 -14900k.png'}" style="width: 80px; height: auto;"></td>
                        <td>${added.id}</td>
                        <td>${added.name}</td>
                        <td>${parseFloat(added.price).toLocaleString()} VND</td>
                        <td>${added.brand}</td>
                        <td>${added.warranty}</td>
                    `;
                    document.getElementById('product-list').appendChild(row);
                });
            });
        } catch (err) {
            alert('Không thể đọc file: ' + err.message);
        }
    };
    reader.readAsText(file);
});

    </script>
</body>

</html>